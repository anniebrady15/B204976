---
title: "Does the prescription of antibiotics commonly used to treat respiratory infections correlate with the number of COVID-19 cases?"
author: "Annie Brady"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  message=FALSE, warning=FALSE)
```

```{r}
library(tidyverse)
library(janitor) # cleaning data
library(here) # for help importing data
library(wesanderson) #for colouring the graphs
library(knitr) #for making tables
library(kableExtra) #for improving my tables
```
## Introduction
The data used in this report can be found at Public Health Scotland:
https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community

In this report, I will explore the relationship between the prescription of nine antibiotics commonly prescribed on the NHS to treat respiratory infections, and the number of COVID-19 cases in Scotland in 2020 and 2021.

Antimicrobial resistance (AMR) is a growing global concern, and one of the key contributors to its rise is the overuse and misuse of antibiotics. In this context, it is crucial to understand how patterns of antibiotic prescribing may be influenced by factors such as the COVID-19 pandemic. Specifically, I aim to investigate whether the prescription rates of these antibiotics rose and fell with the number of COVID-19 cases, potentially indicating the prescription of antibiotics to people suffering from COVID, not bacterial infections. It is important to note that COVID-19 is caused by a virus, and antibiotics are not effective in treating viral infections. Therefore, any rise in prescriptions could reflect inappropriate use of antibiotics, which may contribute to the AMR problem.

## 2021
### Prescription Data
```{r}
data_jan2021 <- read.csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6caa7144-f0e4-4ab0-b9e4-8fa10c8edf1c/download/pitc202301.csv") %>% 
  clean_names() %>% 
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))
#Using the 'clean_names' function to clean up the column names by adding underscores and making them all lowercase. I then use the 'str_detect' command to filter for any rows containing the above drug names in the column "bnf_item_description".
```
I'm going to create a function to simplify the import, cleaning and filtering of my data, as I will have to do the same thing to each month. I have added a line of code to remove values that are not whole number from the 'paid_quantity' column. This is because some of the datasets have errors where this column has a decimals, which is not possible as it is not possible to give 0.5 of a prescription.

The Drugs I'm filtering for and why: Phenoxymethylpenicillin, Amoxicillin, co-Amoxiclav, Azithromycin, Clarithromycin, Erythromycin, Vibramycin-D (doxycycline), Doxycycline, Cefalexin.
```{r}
function_clean_filter_drugs <- function(data_url) {
  data_url %>% #specifies to expect a URL
    read_csv() %>% 
    clean_names() %>% 
    filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN"))) %>% 
    filter(paid_quantity == floor(paid_quantity)) #floor rounds down to the nearest whole number, so this line filters for values in 'paid_quantity' that have no decimals.
}
```
Now I'm going to join hb_names to jan_2021, and plot this on a graph
```{r}
hb_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv", show_col_types = FALSE) %>% 
  clean_names() %>% 
  select(hb, hb_name) #removed id and date archived/enacted, as they are not needed for this analysis. Similarly, the country code is not necessary, as they are all in Scotland.
jan2021_hb_monthly_total <- data_jan2021 %>% 
  left_join(hb_names, join_by(hbt == hb))%>% 
  filter(hb_name != "NA") %>%  # removing rows with NA.
  group_by(hb_name) %>% 
  summarise(total_prescriptions = sum(paid_quantity))

jan2021_hb_monthly_total %>% 
  ggplot(aes(x = hb_name, y = total_prescriptions))+
  geom_col(fill = "lightblue")+
  labs(title = "Total Antibiotic Prescriptions per Health Board (Jan 2021)",
       x = "Health Board", 
       y = "Total Prescriptions") +
  coord_flip()+
  theme_bw()
```

### COVID-19 Data  
Now I want to load the COVID data from Public Health Scotland - this data set is "Weekly Tests and Cases by Health Board" from the "Viral Respiratory Diseases (Including Influenza and COVID-19) Data in Scotland" colleciton. I chose this set so that I can join it to my other data by healthboard.
```{r}
covid_cases_tests_hb <- read_csv("https://www.opendata.nhs.scot/dataset/49dc2d88-1cb0-4420-a5ea-d1bbada62fb2/resource/2803acc8-8ec3-4c4a-81a5-f10952bf66f4/download/weekly_tests_cases_hb_20241030.csv") %>% 
  clean_names() %>% 
  filter(hb != "S92000003") %>% #removed the aggregated data for the whole of Scotland
  mutate(week_ending = ymd(week_ending)) #convert the week_ending column from dbl to date for easier analysis.
```
Filter for the year 2021 and then turn weekly cases into monthly cases - create a graph tracking cases?
```{r}
covid_monthly_total_2021 <- covid_cases_tests_hb %>% 
  filter(year(week_ending) == 2021) %>% #filter for only the year 2021
  mutate(month = month(week_ending)) %>% #create a column containing the month so that group_by can be applied 
  group_by(month) %>% 
  summarise(monthly_cases = sum(weekly_cases)) %>% #add up the weekly cases, presenting total per month.
    mutate(month = recode(month, "1" = "january","2" = "february","3" = "march","4" = "april","5" = "may","6" = "june","7" = "july","8" = "august", "9" = "september","10" = "october","11" = "november","12" = "december"))
```
Plan for the rest of the assignment:  
Download and clean the data for the remaining months of 2021 using `function_clean_filter_drugs`.  
Calculate the total prescriptions for each month.  
Join them together, and then join this with `covid_monthly_total_2021`.  
Visualise this using geom_point and geom_smooth to assess correlation between antibiotic prescriptions and COVID cases in 2021. Could use a statistical test to calculate correlation (Pearsons).  
Repeat with 2020. 
EITHER.  
Then compare this with a non-COVID year (2019). Use a statistical test to assess if there is a significant difference in antibiotic prescriptions between COVID and non-COVID years.    
OR.   
Then, aggregate the data and see if there is health board that was especially bad for it (divide total antibiotic prescriptions by the number of people living in that healthboard and compare.  
