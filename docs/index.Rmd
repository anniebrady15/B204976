---
title: "The Influence of Flu Season (and COVID?) on Antibiotic Prescriptions"
author: "Annie Brady"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
**Could do "Does the prescription of antibiotics (commonly treating respiratory infections) peak and fall with COVID-19 cases?"
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(janitor) # cleaning data
library(here) # for help importing data
library(wesanderson) #for colouring the graphs
library(knitr) #for making tables
library(kableExtra) #for improving my tables
library(patchwork)
```

The data is from Public Health Scotland, found here:
https://www.opendata.nhs.scot/dataset/prescriptions-in-the-community

## Starting with January 2023 

```{r}
data_jan2023 <- read.csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6caa7144-f0e4-4ab0-b9e4-8fa10c8edf1c/download/pitc202301.csv") %>% 
  clean_names() #this cleans up the column names, adding underscores and making them all lowercase
  

gp_addresses <- read_csv("https://www.opendata.nhs.scot/dataset/f23655c3-6e23-4103-a511-a80d998adb90/resource/993422a6-c64f-4c57-ba41-9279ad5a7c89/download/practice_contactdetails_jan2023-open-data.csv", show_col_types = FALSE) %>% 
  #show_col_types = FALSE prevents a message from being printed in the console, indicating the data type of each column. This message is not needed when reading in multiple files.
  clean_names() %>% 
  select(practice_code, gp_practice_name, data_zone, hb) # select for only the columns needed.
 
hb_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv", show_col_types = FALSE) %>% 
  clean_names() %>% 
  select(hb, hb_name) #removed id and date archived/enacted, as they are not needed for this analysis. Similarly, the country code is not necessary, as they are all in Scotland.
```

Talk about the Drugs I'm filtering for and why: Phenoxymethylpenicillin, Amoxicillin, co-Amoxiclav, Azithromycin, Clarithromycin, Erythromycin, Vibramycin-D (doxycycline), Doxycycline, Cefalexin.

```{r }
data_jan2023 <- data_jan2023 %>% 
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))
#I'm overwriting the object to save memory, and then using the str_detect command to filter for any rows containing the above drug names in the column "bnf_item_description".
```

Joining with the GP address data and the Health Board Names data, so that later on I can compare the prescription rate between health boards and gp practices.
```{r }
jan2023_gp <- data_jan2023 %>% 
  left_join(gp_addresses, join_by(hbt == hb), relationship = "many-to-many")
#using a left_join to keep all of the data in data_jan2023, and only matching rows in gp_addresses. hbt == hb is because the health board column has a different name in dataframe.
  
jan2023_hb <- data_jan2023 %>% 
  left_join(hb_names, join_by(hbt == hb))%>% 
  filter(hb_name != "NA") # removing rows with NA.
```

Calculate the Total of these antibiotics (routinely prescribed for chest infections) across Scotland for January 2023

```{r }
jan2023_total <- data_jan2023 %>% 
  summarise(total = sum(paid_quantity))
```

Calculate the Total of these antibiotics (routinely prescribed for chest infections) across Scotland for January 2023 per health board

```{r }
jan2023_total_per_hb <- jan2023_hb %>% 
  group_by(hb_name) %>% 
  summarise(monthly_total = sum(paid_quantity)) 

jan2023_total_per_hb %>% 
   adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in January 2023") %>% 
  kable_styling("striped", full_width = FALSE)
```

Now I will do the same steps to generate these total for the month of July 2023.

```{r }
data_july2023 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7bb45ee6-6f1c-45f4-933b-958bdbe0ca4f/download/pitc202307.csv", show_col_types = FALSE) %>% 
  clean_names()
```

```{r }
data_july2023 <- data_july2023 %>% 
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))
```

```{r }
july2023_gp <- data_july2023 %>% 
  left_join(gp_addresses, join_by(hbt == hb), relationship = "many-to-many")
  
july2023_hb <- data_july2023 %>% 
  left_join(hb_names, join_by(hbt == hb))%>% 
  filter(hb_name != "NA")
```

```{r}
july2023_total_per_hb <- july2023_hb %>% 
  group_by(hb_name) %>% 
  summarise(monthly_total = sum(paid_quantity))

july2023_total_per_hb %>% 
  adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in July 2023") %>% 
  kable_styling("striped", full_width = FALSE)
```

Calculate the total of these prescriptions for 2023 January and July
```{r}
jan2023_total <- data_jan2023 %>% 
  summarise(total = sum(paid_quantity))

july2023_total <- data_july2023 %>% 
  summarise(total = sum(paid_quantity))
```

Join January and July to each other. Full join used because all of the data in both dataframes are required. The data is then reformatted using pivot_longer so that it can be made into a bar chart (geom_col) for comparison between the two months.
```{r}
jan_july23_totals_hb <- jan2023_total_per_hb %>% 
  full_join(july2023_total_per_hb, by = "hb_name") %>% 
  rename(
    january = monthly_total.x,  # Rename the January total column
    july = monthly_total.y) %>%        # Rename the July total columnn
  pivot_longer(cols = c(january, july),  # Columns to reshape
               names_to = "month",  # New column for month
               values_to = "prescriptions")
```

```{r}
jan_july23_totals_hb %>% 
    ggplot(aes(x = hb_name,
         y = prescriptions,
         fill = month))+
  geom_col(position = "dodge")+
  labs(x = "Health Board", y = "Monthly Total")+
  theme_bw() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6)) +
  scale_fill_manual(values = wes_palette("GrandBudapest2", 2)) +
   coord_flip()
```

This graph nicely shows how much higher the prescription rate is these antibiotics (commonly prescribed for chest infections) are in January than July in 2023. 

Now I want to know if this trend can be seen in other years - so I am going to look at 2017, 2019 and 2021.

I will start with 2021. Here I load the data and filter it for the antibiotics I want.
```{r}
data_jan2021 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7722a6e6-a6b6-49ec-aa63-fdc4bc727f05/download/pitc202101.csv", show_col_types = FALSE) %>% 
  clean_names() %>%
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))

data_july2021 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/5c1cd207-1958-4105-923f-ab60983d3f90/download/pitc202107.csv", show_col_types = FALSE) %>% 
  clean_names() %>% 
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))
```

Had to remove a row, because there can't be a .5 in paid quantity, so it must be a mistake. Therefore it had to be removed.
```{r}
jan2021_hb <- data_jan2021 %>% 
  left_join(hb_names, join_by(hbt == hb))%>% 
  filter(hb_name != "NA") %>% 
  filter(paid_quantity != 42.5)
```

```{r}
jan2021_total_per_hb <- jan2021_hb %>% 
  group_by(hb_name) %>% 
  summarise(jan_total_prescriptions = sum(paid_quantity))

jan2021_total_per_hb %>% 
   adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in January 2021") %>% 
  kable_styling("striped", full_width = FALSE)
```

Now do it all with July 2021!
```{r}
july2021_hb <- data_july2021 %>% 
  left_join(hb_names, join_by(hbt == hb))%>% 
  filter(hb_name != "NA")
```

```{r}
july2021_total_per_hb <- july2021_hb %>% 
  group_by(hb_name) %>% 
  summarise(july_total_prescriptions = sum(paid_quantity))

july2021_total_per_hb %>% 
   adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in July 2021") %>% 
  kable_styling("striped", full_width = FALSE)

```

Join January and July to each other. Full join used because all of the data in both dataframes are required. The data is then reformatted using pivot_longer so that it can be made into a bar chart (geom_col) for comparison between the two months.
```{r}
jan_july21_totals_hb <- jan2021_total_per_hb %>% 
  full_join(july2021_total_per_hb, by = "hb_name") %>%
  rename(
    january = jan_total_prescriptions,
    july = july_total_prescriptions
  ) %>% 
  pivot_longer(cols = c(january, july),  # Columns to reshape
               names_to = "month",  # New column for month
               values_to = "prescriptions")
```

```{r}
plot_prescriptions_2021 <- jan_july21_totals_hb %>% 
    ggplot(aes(x = hb_name,
         y = prescriptions,
         fill = month))+
  geom_col(position = "dodge")+
  labs(x = "Health Board", y = "Monthly Total")+
  theme_bw() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6)) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", 2)) +
   coord_flip()
```

Calculate the total of these prescriptions for 2021 January and July
```{r}
jan2021_total <- data_jan2021 %>% 
  mutate(total = sum(paid_quantity)) %>% 
  select(hbt, total)

july2021_total <- data_july2021 %>% 
  mutate(total = sum(paid_quantity)) %>% 
  select(hbt, total)
```
Here we can see that July has higher rates of prescription of this antibiotic. This is different to 2023. What was going on in the world/Scotland during this time? How do rates compare to the same months in different years?

I want to see if the trend continues - lets look at other years.

2019:
```{r}
data_jan2019 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/3bd6e3cc-b8b7-493b-b6aa-f9fcadbb05d2/download/pitc201901.csv", show_col_types = FALSE) %>% 
  clean_names() %>%
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))

data_july2019 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/6e3856e9-88cb-495a-8c8a-54b0460df950/download/pitc201907.csv", show_col_types = FALSE) %>% 
  clean_names() %>% 
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))
```

```{r}
jan2019_hb <- data_jan2019 %>% 
  left_join(hb_names, join_by(hbt2014 == hb))%>% 
  filter(hb_name != "NA")
```

```{r}
jan2019_total_per_hb <- jan2019_hb %>% 
  group_by(hb_name) %>% 
  summarise(monthly_total = sum(paid_quantity))

jan2019_total_per_hb %>% 
   adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in January 2019") %>% 
  kable_styling("striped", full_width = FALSE)
```

Now do it all with July 2019!

Had to remove a row, because there can't be a .5 in paid quantity, so it must be a mistake. Therefore it had to be removed.
```{r}
july2019_hb <- data_july2019 %>% 
  left_join(hb_names, join_by(hbt2014 == hb))%>% 
  filter(hb_name != "NA")%>% 
  filter(paid_quantity != 6.5)
```

```{r}
july2019_total_per_hb <- july2019_hb %>% 
  group_by(hb_name) %>% 
  summarise(monthly_total = sum(paid_quantity)) 

july2019_total_per_hb %>% 
   adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in July 2019") %>% 
  kable_styling("striped", full_width = FALSE)
```

Join January and July to each other. Full join used because all of the data in both dataframes are required. The data is then reformatted using pivot_longer so that it can be made into a bar chart (geom_col) for comparison between the two months.
```{r}
jan_july19_totals_hb <- jan2019_total_per_hb %>% 
  full_join(july2019_total_per_hb, by = "hb_name") %>% 
  rename(
    january = monthly_total.x,  # Rename the January total column
    july = monthly_total.y) %>%        # Rename the July total columnn
  pivot_longer(cols = c(january, july),  # Columns to reshape
               names_to = "month",  # New column for month
               values_to = "prescriptions")
```

```{r}
jan_july19_totals_hb %>% 
    ggplot(aes(x = hb_name,
         y = prescriptions,
         fill = month))+
  geom_col(position = "dodge")+
  labs(x = "Health Board", y = "Monthly Total")+
  theme_bw() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6)) +
  scale_fill_manual(values = wes_palette("Darjeeling2", 2)) +
   coord_flip()
```

Calculate the total of these prescriptions for 2019 January and July
```{r}
jan2019_total <- data_jan2019 %>% 
  summarise(total = sum(paid_quantity))

july2019_total <- data_july2019 %>% 
  summarise(total = sum(paid_quantity))
```

2017:
```{r}
data_jan2017 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/3def845e-c830-4b73-8e02-e42adcde5afa/download/pitc201701.csv", show_col_types = FALSE) %>% 
  clean_names() %>%
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))

data_july2017 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/44bc24dd-3a8e-4056-8ee2-eb903bc352ac/download/pitc201707.csv", show_col_types = FALSE) %>% 
  clean_names() %>% 
  filter(str_detect(bnf_item_description, c("PHENOXYMETHYLPENICILLIN|AMOXICILLIN| CO_AMOXICLAV|AZITHROMYCIN|CLARITHROMYCIN|ERYTHROMYCIN|VIBRAMYCIN|DOXYCYCLINE|CEFALEXIN")))
```
 Had to remove a row, because there can't be a .5 in paid quantity, so it must be a mistake. Therefore it had to be removed.
```{r}
jan2017_hb <- data_jan2017 %>% 
  left_join(hb_names, join_by(hbt2014 == hb))%>% 
  filter(hb_name != "NA")%>% 
  filter(paid_quantity != 3.5)
```

```{r}
jan2017_total_per_hb <- jan2017_hb %>% 
  group_by(hb_name) %>% 
  summarise(monthly_total = sum(paid_quantity))

jan2017_total_per_hb %>% 
   adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in January 2017") %>% 
  kable_styling("striped", full_width = FALSE)
```

Now do it all with July 2017!

Had to remove a row, because there can't be a .5 in paid quantity, so it must be a mistake. Therefore it had to be removed.
```{r}
july2017_hb <- data_july2017 %>% 
  left_join(hb_names, join_by(hbt2014 == hb))%>% 
  filter(hb_name != "NA")%>% 
  filter(paid_quantity != 47.5)
```

```{r}
july2017_total_per_hb <- july2017_hb %>% 
  group_by(hb_name) %>% 
  summarise(monthly_total = sum(paid_quantity))

july2017_total_per_hb %>% 
   adorn_totals() %>% 
  kable(col.names = c("Health Board", "Total Monthly Prescriptions"), align = "lcc",
        caption = "Antibiotic Prescriptions per Health Board in July 2019") %>% 
  kable_styling("striped", full_width = FALSE)
```

Join January and July to each other. Full join used because all of the data in both dataframes are required. The data is then reformatted using pivot_longer so that it can be made into a bar chart (geom_col) for comparison between the two months.
```{r}
jan_july17_totals_hb <- jan2017_total_per_hb %>% 
  full_join(july2017_total_per_hb, by = "hb_name") %>% 
  rename(
    january = monthly_total.x,  # Rename the January total column
    july = monthly_total.y) %>%        # Rename the July total columnn
  pivot_longer(cols = c(january, july),  # Columns to reshape
               names_to = "month",  # New column for month
               values_to = "prescriptions")
```

```{r}
jan_july17_totals_hb %>% 
    ggplot(aes(x = hb_name,
         y = prescriptions,
         fill = month))+
  geom_col(position = "dodge")+
  labs(x = "Health Board", y = "Monthly Total")+
  theme_bw() +
  theme(axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6)) +
  scale_fill_manual(values = wes_palette("Chevalier1", 2)) +
   coord_flip()
```

Calculate the total of these prescriptions for 2019 January and July
```{r}
jan2017_total <- data_jan2017 %>% 
  summarise(total = sum(paid_quantity))

july2017_total <- data_july2017 %>% 
  summarise(total = sum(paid_quantity))
```

I want to know if the strange result in 2021 correlated with peaks in COVID cases.
I'm going to use "Weekly Tests and Cases by Health Board" from Public Health Scotland.
Convert week_ending into year-month-day / ymd() using lubridate
```{r}
COVID_cases_tests_hb <- read_csv("https://www.opendata.nhs.scot/dataset/49dc2d88-1cb0-4420-a5ea-d1bbada62fb2/resource/2803acc8-8ec3-4c4a-81a5-f10952bf66f4/download/weekly_tests_cases_hb_20241030.csv", show_col_types = FALSE) %>% 
  clean_names() %>% 
  filter(hb != "S92000003") %>% #removed the aggregated data for the whole of Scotland
  mutate(week_ending = ymd(week_ending)) #convert the week_ending column from dbl to date for easier analysis.

```
Filter for the year (2021) and then turn weekly cases into monthly cases - create a graph tracking cases?

```{r}
COVID_cases_2021_month <- COVID_cases_tests_hb %>% 
  filter(year(week_ending) == 2021) %>% #filter for only the year 2021
  mutate(month = month(week_ending)) #create a column containing the month so that group_by can be applied 

COVID_monthly_total_2021 <- COVID_cases_2021_month %>% 
  group_by(month) %>% 
  summarise(monthly_cases = sum(weekly_cases)) #add up the weekly cases, presenting total per month.

#Table with totals for each month
covid_jan_july <- COVID_monthly_total_2021 %>% 
  filter(month == 1 | month == 7) %>% 
  mutate(month = recode(month, `1` = "January", `7` = "July"))
  
```
This data shows that COVID cases were high in July than January in 2021 - this may explain the higher in antibiotic prescriptions in July. This is also a problem however - antibiotics do not treat COVID.
Now filter for Jan and July, then join to the prescription data for comparison
```{r}
jan_2021_COVID <- COVID_cases_2021_month %>% 
  filter(month == 1) %>% 
  group_by(hb) %>% 
  summarise(jan_covid = sum(weekly_cases))

july_2021_COVID <- COVID_cases_2021_month %>% 
  filter(month == 7) %>% 
  group_by(hb) %>% 
  summarise(july_covid = sum(weekly_cases))
  
jan_july_2021_COVID <- jan_2021_COVID %>% 
  full_join(july_2021_COVID, by = "hb")
```
Now join this to my prescription data
```{r}
hb_compare_2021_drug_covid <- jan_july_2021_COVID %>% 
  full_join(jan2021_total_per_hb, join_by(hb == hbt)) %>% 
  full_join(july2021_total_per_hb, join_by(hb == hbt))
```

Creating a graoh! THIS DOESNT WORK
```{r}
plot_2021_drug_covid<- hb_compare_2021_drug_covid %>% 
  pivot_longer(cols = c(jan_covid, july_covid, jan_total_prescriptions, july_total_prescriptions),
               names_to = "month",
               values_to = "total") %>% 
  ggplot(aes(x = hb,
             y = total,
             colour = month,
             group = month))+
  geom_line()
  
```
different graph - need a better way to present this - dont divide by health board? just totals.
```{r}
plot_covid <- jan_july_2021_COVID %>%
  pivot_longer(cols = c(jan_covid, july_covid),
               names_to = "month",
               values_to = "total_cases") %>% 
  ggplot(aes(x = hb,
             y = total_cases,
             fill = month)) +
  geom_col(position = "dodge") +
  coord_flip()
  
plot_covid + plot_prescriptions_2021
```
This one will just include totals for each month. This is better - compare it to other years?
```{r}
plot_1 <- covid_jan_july %>% 
  ggplot(aes(x = month,
             y = monthly_cases))+
  geom_col()

jan_july_prescriptions <- jan2021_total %>% 
  full_join(july2021_total, by = "hbt", relationship = "many-to-many") %>%
  summarize(
    january = mean(total.x, na.rm = TRUE),
    july = mean(total.y, na.rm = TRUE)
  ) %>% 
  pivot_longer(cols = c(january, july),
               names_to = "month",
               values_to = "total_prescriptions")

plot_2 <- jan_july_prescriptions %>% 
  ggplot(aes(x = month,
             y = total_prescriptions))+
  geom_col()

plot_1 + plot_2
```

